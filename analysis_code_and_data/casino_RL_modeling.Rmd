---
title: "Casino Task Analyses: RL Modeling Results"
date: "1/27/2022"
output: 
  html_document:
    df_print: paged
    theme: flatly
    toc: yes
    toc_depth: 4
    toc_float: yes
---
<style type="text/css">
h1.title {
font-size: 38px;
}
h1 { /* Header 1 */
font-size: 28px;
}
h2 { /* Header 2 */
font-size: 22px;
}
h3 { /* Header 3 */
font-size: 18px;
}

</style>
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, warning = F, message = F, cache = T)
knitr::opts_chunk$set(fig.path = "figures/")
knitr::opts_chunk$set(fig.width=7, fig.height = 4.5, dpi = 600)
```

```{r load libraries and functions}
# Load needed libraries
library(tidyverse)
library(glue)
library(magrittr)
library(afex)
library(knitr)
library(kableExtra)
library(broom)

#define scale function
scale_this <- function(x){
  (x - mean(x, na.rm=TRUE)) / sd(x, na.rm=TRUE)
}

#standard error function
se <- function(x){
  sd(x, na.rm = T)/sqrt(length(x))
}
```

```{r define plot aesthetics }
#define colors to use for plots
color1 = "#FFDD3C"
color2 = "#378bf1"
color3 = "grey"

#define plotting theme
casino.theme <- theme(panel.background = element_rect(fill='transparent'),
                    axis.line = element_line(color='black'),
                    panel.grid.minor = element_line(color='transparent'),
                    axis.title.x = element_text(size=16, vjust=-.25),
                    axis.title.y = element_text(size=16, vjust=1),
                    axis.text.x = element_text(size=12, colour="black"),
                    axis.text.y = element_text(size=12, colour="black"),
                    legend.text=element_text(size=12),
                    legend.title = element_text(size = 14),
                    plot.title = element_text(size=16, face = "bold", hjust = .5), 
                    strip.text.x = element_text(size=12), 
                    strip.text.y = element_text(size=12, face="bold"), 
                    strip.background = element_rect(colour= "black", fill = "transparent"))
```

```{r read in data}
#define data directory
data_dir = "data/task_data/"

#get list of files
data_files <- list.files(path = data_dir, pattern = "*.csv")

#get list of subject ages
sub_ages <- read_csv("data/other_data_files/sub_ages.csv")

#initialize data frame
data <- data.frame()

# Read in data
for (i in c(1:length(data_files))){
  sub_data <- read_csv(glue("{data_dir}{data_files[i]}"), show_col_types = F) 
  
  #compute the number of browser interactions
  num_interactions = length(str_split(tail(sub_data,1)$interactions, pattern = "\r\n")[[1]]) - 2
  sub_data$num_interactions <- num_interactions
  
  #compute number of quiz questions answered correctly
  num_quiz_attempts = nrow(sub_data %>% 
                             filter(trial_type == "casino-comp_q"))
  sub_data$quiz_attempts <- num_quiz_attempts
  
  #combine subject data into larger data frame
  data <- rbind(data, sub_data)
}

# read in list of subjects to include
included_subs <- read_csv("data/other_data_files/sub_ages_inc.csv")

#join with data
filtered_data <- inner_join(data, included_subs, by = c("sub_id")) 

#re-order age groups
filtered_data %<>% mutate(age_group = 
                            factor(age_group, levels = c("Children", "Adolescents", "Adults")))
```

# Model comparison
```{r read in all aics}
aic_name <- "RL_modeling/output/model_fits_real_data/aics_all.csv"
aics <- read_csv(aic_name)

#add age groups
matlab_ids <- filtered_data %>%
  select(matlab_id, sub_id, age, age_group, gender, risk_good_first) %>%
  unique()
  
aics <- full_join(matlab_ids, aics, by = c("matlab_id")) %>%
  drop_na() %>%
  select(-c(matlab_id, gender))

#pivot longer
aic_long <- aics %>%
  pivot_longer(names_to = "model",
               values_to = "aic",
               -c(sub_id, age, age_group, risk_good_first))

#static LR models
aic_static <- aic_long %>%
  filter(!startsWith(model, "decay")) %>%
  mutate(model_type = case_when(endsWith(model, "L") ~ "Non-sticky",
                                endsWith(model, "S") ~ "Sticky")) 

#models with stickiness
aic_sticky <- aic_long %>%
  filter(!endsWith(model, "L")) %>%
  mutate(model_type = case_when(startsWith(model, "decay") ~ "Decaying Learning Rate",
                                endsWith(model, "S") ~ "Static Learning Rate")) 

aic_sticky$model_type = factor(aic_sticky$model_type, levels = c("Static Learning Rate", "Decaying Learning Rate"))
```


```{r compute mean aics for each model type}
#static models
mean_aic_static <- aic_static %>%
  group_by(model, model_type) %>%
  summarize(mean_aic = mean(aic),
            se_aic = se(aic),
            N = n())

mean_age_group_aic_static <- aic_static %>%
  group_by(age_group, model, model_type) %>%
  summarize(mean_aic = mean(aic))

#models with stickiness
mean_aic_sticky <- aic_sticky %>%
  group_by(model, model_type) %>%
  summarize(mean_aic = mean(aic),
            se_aic = se(aic))

mean_age_group_aic_sticky <- aic_sticky %>%
  group_by(age_group, model, model_type) %>%
  summarize(mean_aic = mean(aic))
```

## Mean aic values: Static models with and without stickiness
```{r mean aic plot static models, fig.height = 4, fig.width = 5}
aic_overall_plot_static <- ggplot(mean_aic_static, aes(x = model, y = mean_aic, fill = model_type, size = model)) +
  geom_bar(stat = "identity", position = "dodge", color = "black") +
  scale_size_manual(values = c(.2, .2, .2, .2, .2, 1),
                    guide = "none") +
  geom_text(aes(label=round(mean_aic, 1)), vjust= -.6, color="black", size=4)+
  scale_fill_manual(values = c(color1, color2), name = "Model Type") + 
  scale_x_discrete(labels = c("1", "1", "2", "2", "4", "4"),
                   name = "Learning Rates") +
  coord_cartesian(ylim = c(425, 510)) +
  ylab("Mean AIC") +
  casino.theme +
  theme(legend.position = "top")
aic_overall_plot_static
```

## Mean aic values across age groups: Static models
```{r aic age group plot static, fig.height = 4, fig.width = 8}
aic_age_group_plot_static <- ggplot(mean_age_group_aic_static, aes(x = model, fill = model_type, y = mean_aic, size = model)) +
  facet_wrap(~age_group) +
  geom_bar(stat = "identity", position = "dodge", color = "black") +
  geom_text(aes(label=round(mean_aic, 1)), vjust= -.6, color="black", size=3)+
    scale_size_manual(values = c(.2, .2, .2, .2, .2, 1),
                    guide = "none") +
  scale_fill_manual(values = c(color1, color2), name = "Model Type") + 
  scale_x_discrete(labels = c("1", "1", "2", "2", "4", "4"),
                   name = "Learning Rates") +
  ylab("Mean AIC") +
  coord_cartesian(ylim = c(425, 510)) +
  casino.theme +
  theme(legend.position = "top")
aic_age_group_plot_static
```

## Mean aic values: Static models with stickiness
```{r mean aic plot static with stickiness, fig.height = 4, fig.width = 3}
mean_aic_static_sticky <- mean_aic_static %>%
  filter(model_type == "Sticky")

aic_overall_plot_static_sticky <- ggplot(mean_aic_static_sticky, aes(x = model, y = mean_aic, size = model)) +
  geom_bar(stat = "identity", position = "dodge", color = "black", fill = color2) +
  scale_size_manual(values = c(.2, .2, 1),
                    guide = "none") +
  geom_text(aes(label=round(mean_aic, 1)), vjust= -.6, color="black", size=4)+
  scale_x_discrete(labels = c("1", "2", "4"),
                   name = "Learning Rates") +
  coord_cartesian(ylim = c(425, 510)) +
  ylab("Mean AIC") +
  casino.theme +
  theme(legend.position = "top")
aic_overall_plot_static_sticky
```

## Mean aic values across age groups: Static models with stickiness
```{r aic age group plot static with sticky, fig.height = 4, fig.width = 5}
mean_age_group_aic_static_sticky <- mean_age_group_aic_static %>%
  filter(model_type == "Sticky")

aic_age_group_plot_static_sticky <- ggplot(mean_age_group_aic_static_sticky, aes(x = model, y = mean_aic, fill = age_group, size = model)) +
  facet_wrap(~age_group) +
  geom_bar(stat = "identity", position = "dodge", color = "black") +
  geom_text(aes(label=round(mean_aic, 1)), vjust= -.6, color="black", size=3)+
    scale_size_manual(values = c(.2, .2, 1),
                    guide = "none") +
  scale_fill_manual(values = c(color1, color2, color3), name = "Age Group",
                    guide = "none") + 
  scale_x_discrete(labels = c("1", "2", "4"),
                   name = "Learning Rates") +
  ylab("Mean AIC") +
  coord_cartesian(ylim = c(425, 510)) +
  casino.theme +
  theme(legend.position = "top")
aic_age_group_plot_static_sticky
```


## Proportion of participants best fit by each model: Static w/ stickiness
```{r aic proportions, fig.height = 4}
aics <- aics %>%
  mutate(best_model = 
           case_when(`1LS` < `2LS` & `1LS` < `4LS`   ~ '1LR',
                     `2LS` < `1LS` & `2LS` < `4LS`   ~ '2LR',
                     `4LS` < `1LS` & `4LS` < `1LS`   ~ '4LR'))

aic_props <- aics %>%
  group_by(age_group, best_model) %>%
  summarise(n = n()) %>%
  mutate(freq = n/sum(n))
                                
aic_props_plot <- ggplot(aic_props, aes(best_model, age_group, fill = freq)) +
  geom_tile(color = "black", aes(size = factor(freq))) +
  scale_size_manual(values = c(.25, .25, .25, .25, .25, .25, .75, .75, .75), guide = "none") +
  geom_text(aes(label = round(freq, 2))) +
  scale_fill_gradient(low = "white", high = color2, "Proportion Best Fit", 
                      guide = guide_colorbar(label = T, 
                                       draw.ulim = TRUE, 
                                       draw.llim = TRUE, 
                                       frame.colour = "black", 
                                       ticks = T,
                                       barheight = 10)) +
  ylab("") +
  scale_x_discrete(labels = c("1", "2", "4"), name = "Learning Rates") +
  casino.theme +
  theme(axis.line = element_blank()) 
 aic_props_plot 
```

## Mean aic values: Static and decay models
```{r mean aic plot static and decay, fig.height = 4, fig.width = 8}
x_labs = c(expression("1LR", "2LR", "4LR",
                      paste(1~alpha, ", ", 1~eta),
                      paste(1~alpha, ", ", 2~eta),
                      paste(1~alpha, ", ", 4~eta),
                      paste(2~alpha, ", ", 1~eta),
                      paste(2~alpha, ", ", 2~eta),
                      paste(2~alpha, ", ", 4~eta),
                      paste(4~alpha, ", ", 1~eta),
                      paste(4~alpha, ", ", 2~eta),
                      paste(4~alpha, ", ", 4~eta)))

aic_overall_plot_sticky <- ggplot(mean_aic_sticky, aes(x = model, y = mean_aic, fill = model_type, size = model)) +
  geom_bar(stat = "identity", position = "dodge", color = "black") +
  scale_size_manual(values = c(.2, .2, 1, .2, .2, .2, .2, .2, .2, .2, 1, .2),
                    guide = "none") +
  geom_text(aes(label=round(mean_aic, 1)), vjust= -.6, color="black", size=4)+
  scale_fill_manual(values = c(color1, color2), name = "Model Type") + 
  scale_x_discrete(labels = x_labs,
                   name = "Model") +
  coord_cartesian(ylim = c(425, 480)) +
  ylab("Mean AIC") +
  casino.theme +
  theme(axis.text.x = element_text(angle = 65, vjust = 0.5),
        legend.position = "top")
aic_overall_plot_sticky
```

## Mean aic values across age groups: Static and decay models
```{r aic age group plot static and decay, fig.height = 5, fig.width = 12}
aic_age_group_plot_sticky <- ggplot(mean_age_group_aic_sticky, aes(x = model, fill = model_type, y = mean_aic)) +
  facet_wrap(~age_group) +
  geom_bar(stat = "identity", position = "dodge", color = "black") +
  geom_text(aes(label=round(mean_aic, 1)), vjust= -.6, color="black", size=3)+
  scale_fill_manual(values = c(color1, color2), name = "Model Type") + 
  scale_x_discrete(labels = x_labs,
                   name = "Model") +
  ylab("Mean AIC") +
  coord_cartesian(ylim = c(425, 510)) +
  casino.theme +
  theme(axis.text.x = element_text(angle = 65, vjust = 0.5),
        legend.position = "top")
aic_age_group_plot_sticky
```




```{r read in all bics}
bic_name <- "RL_modeling/output/model_fits_real_data/bics_all.csv"
bics <- read_csv(bic_name)

#add age groups
matlab_ids <- filtered_data %>%
  select(matlab_id, sub_id, age, age_group, gender, risk_good_first) %>%
  unique()
  
bics <- full_join(matlab_ids, bics, by = c("matlab_id")) %>%
  drop_na() %>%
  select(-c(matlab_id, gender))

#pivot longer
bic_long <- bics %>%
  pivot_longer(names_to = "model",
               values_to = "bic",
               -c(sub_id, age, age_group, risk_good_first))

#static LR models
bic_static <- bic_long %>%
  filter(!startsWith(model, "decay")) %>%
  mutate(model_type = case_when(endsWith(model, "L") ~ "Non-sticky",
                                endsWith(model, "S") ~ "Sticky")) 

#models with stickiness
bic_sticky <- bic_long %>%
  filter(!endsWith(model, "L")) %>%
  mutate(model_type = case_when(startsWith(model, "decay") ~ "Decaying Learning Rate",
                                endsWith(model, "S") ~ "Static Learning Rate")) 

bic_sticky$model_type = factor(bic_sticky$model_type, levels = c("Static Learning Rate", "Decaying Learning Rate"))
```


```{r compute mean bics for each model type}
#static models
mean_bic_static <- bic_static %>%
  group_by(model, model_type) %>%
  summarize(mean_bic = mean(bic),
            se_bic = se(bic),
            N = n())

mean_age_group_bic_static <- bic_static %>%
  group_by(age_group, model, model_type) %>%
  summarize(mean_bic = mean(bic))

#models with stickiness
mean_bic_sticky <- bic_sticky %>%
  group_by(model, model_type) %>%
  summarize(mean_bic = mean(bic),
            se_bic = se(bic))

mean_age_group_bic_sticky <- bic_sticky %>%
  group_by(age_group, model, model_type) %>%
  summarize(mean_bic = mean(bic))
```

## Mean aic values: Static and decay models
```{r mean bic plot static and decay, fig.height = 4, fig.width = 8}
x_labs = c(expression("1LR", "2LR", "4LR",
                      paste(1~alpha, ", ", 1~eta),
                      paste(1~alpha, ", ", 2~eta),
                      paste(1~alpha, ", ", 4~eta),
                      paste(2~alpha, ", ", 1~eta),
                      paste(2~alpha, ", ", 2~eta),
                      paste(2~alpha, ", ", 4~eta),
                      paste(4~alpha, ", ", 1~eta),
                      paste(4~alpha, ", ", 2~eta),
                      paste(4~alpha, ", ", 4~eta)))

bic_overall_plot_sticky <- ggplot(mean_bic_sticky, aes(x = model, y = mean_bic, fill = model_type, size = model)) +
  geom_bar(stat = "identity", position = "dodge", color = "black") +
  scale_size_manual(values = c(.2, .2, 1, .2, .2, .2, .2, .2, .2, .2, 1, .2),
                    guide = "none") +
  geom_text(aes(label=round(mean_bic, 1)), vjust= -.6, color="black", size=4)+
  scale_fill_manual(values = c(color1, color2), name = "Model Type") + 
  scale_x_discrete(labels = x_labs,
                   name = "Model") +
  coord_cartesian(ylim = c(440, 490)) +
  ylab("Mean BIC") +
  casino.theme +
  theme(axis.text.x = element_text(angle = 65, vjust = 0.5),
        legend.position = "top")
bic_overall_plot_sticky
```

## Mean bic values across age groups: Static and decay models
```{r bic age group plot static and decay, fig.height = 5, fig.width = 12}
bic_age_group_plot_sticky <- ggplot(mean_age_group_bic_sticky, aes(x = model, fill = model_type, y = mean_bic)) +
  facet_wrap(~age_group) +
  geom_bar(stat = "identity", position = "dodge", color = "black") +
  geom_text(aes(label=round(mean_bic, 1)), vjust= -.6, color="black", size=3)+
  scale_fill_manual(values = c(color1, color2), name = "Model Type") + 
  scale_x_discrete(labels = x_labs,
                   name = "Model") +
  ylab("Mean BIC") +
  coord_cartesian(ylim = c(425, 510)) +
  casino.theme +
  theme(axis.text.x = element_text(angle = 65, vjust = 0.5),
        legend.position = "top")
bic_age_group_plot_sticky
```


# Parameter estimates from four learning rate model
```{r read in RL results}
#read in parameter estimates
model_params_name <- "RL_modeling/output/model_fits_real_data/params/four_LR_sticky.csv"
model_params <- read_csv(model_params_name, 
                       col_names = c("matlab_id",
                                     "nll",
                                     "logpost",
                                     "bic",
                                     "aic",
                                     "beta",
                                     "sticky",
                                     "alpha_pos1",
                                     "alpha_neg1",
                                     "alpha_pos2",
                                     "alpha_neg2")) %>%
  mutate(asymm_risk_good = (alpha_pos1 - alpha_neg1)/(alpha_pos1 + alpha_neg1),
         asymm_risk_bad = (alpha_pos2 - alpha_neg2)/(alpha_pos2 + alpha_neg2))
```

## Asymmetry indices and task performance
```{r four LR learning rates data processing}
asymmetry_indices <- model_params %>%
  select(matlab_id, asymm_risk_good, asymm_risk_bad) %>%
  pivot_longer(cols = c("asymm_risk_good", "asymm_risk_bad"), 
               names_to = "block_type",
               names_prefix = "asymm_",
               values_to = "AI") %>%
  mutate(block_type = factor(block_type, labels = c("Risk Bad", "Risk Good")))

#add age groups
asymmetry_indices <- inner_join(asymmetry_indices, matlab_ids, by = c("matlab_id"))

#add block order and block number
block_order <- filtered_data %>%
  select(sub_id, risk_good_first) %>%
  unique() %>%
  mutate(block_order = case_when(risk_good_first == "TRUE" ~ "Risk Good First",
                                 risk_good_first == "FALSE" ~ "Risk Bad First")) %>%
  select(sub_id, block_order)

#add block order to asymmetry indices
asymmetry_indices <- inner_join(asymmetry_indices, block_order, by = c("sub_id"))
```

```{r filtered data processing}
learning_data <- filtered_data %>%
      select(c(trial_index,
           sub_id,
           matlab_id,
           age,
           age_group,
           risk_good_first,
           block1_A,
           block1_B, 
           block1_C,
           block1_D,
           block2_A, 
           block2_B,
           block2_C,
           block2_D,
           stimulus,
           task_part,
           card_choice,
           rt,
           choice_position,
           points_earned,
           block,
           num_interactions,
           quiz_attempts)) %>%
    filter(task_part == "real_trial") 

#recode points earned, RT, card choices, risk type, and block type
learning_data %<>% mutate(points_earned = as.numeric(points_earned),
                         rt = as.numeric(rt),
                         card_letter = case_when(card_choice == block1_A ~ "A",
                                         card_choice == block2_A ~ "A",
                                         card_choice == block1_B ~ "B",
                                         card_choice == block2_B ~ "B",
                                         card_choice == block1_C ~ "C",
                                         card_choice == block2_C ~ "C",
                                         card_choice == block1_D ~ "D",
                                         card_choice == block2_D ~ "D"),
                         card_type = case_when(card_letter == "A" ~ "risky",
                                       card_letter == "B" ~ "risky",
                                       card_letter == "C" ~ "safe",
                                       card_letter == "D" ~ "safe"), 
                         block_number = as.factor(block),
                         block_type = case_when(risk_good_first == "TRUE" & block == 1 ~ "Risk Good",
                                        risk_good_first == "TRUE" & block == 2 ~ "Risk Bad",
                                        risk_good_first == "FALSE" & block == 1 ~ "Risk Bad",
                                        risk_good_first == "FALSE" & block == 2 ~ "Risk Good"))
```

### AI vs. points earned
```{r total points vs. lr asymmetry}
#total points vs. lr asymms
total_points <- learning_data %>%
  group_by(matlab_id, block_type) %>%
  summarize(total_points = sum(points_earned, na.rm = T)) 

#merge w/ model fits
AI_points <- full_join(total_points, 
                       asymmetry_indices, 
                       by = c("matlab_id", "block_type"))

#plot
LR_points_plot <- ggplot(AI_points, aes(x = AI, y = total_points, color = block_type)) +
  facet_wrap(~block_type) +
  geom_point() +
  scale_color_manual(values = c(color1, color2)) +
  geom_smooth(method = "lm", color = "black", aes(fill = block_type)) +
  scale_fill_manual(values = c(color1, color2)) +
  ylab("Points Earned") +
  xlab("Learning Rate Asymmetry") +
  casino.theme +
  theme(legend.position = "none")
LR_points_plot
```

### Model: AI vs. points earned
```{r AI and points earned model, include = F}
#scale continuous variables
AI_points$age_scaled = scale_this(AI_points$age)
AI_points$AI_scaled = scale_this(AI_points$AI)

AI.points.model <- mixed(total_points ~ age_scaled * block_type * AI_scaled + (1|sub_id), 
                  data = AI_points,
                  method = "S",
                  expand_re = T)
```

```{r display AI points model output}
nice(AI.points.model)
```

### AI vs. optimal choices
```{r AI optimal choice plot}
prop_opt_choices <- learning_data %>%
  mutate(opt_choice = case_when(card_type == 'risky' & block_type == "Risk Good" ~ 1,
                                card_type == 'risky' & block_type == "Risk Bad" ~ 0,
                                card_type == 'safe' & block_type == "Risk Good" ~ 0,
                                card_type == 'safe' & block_type == "Risk Bad" ~ 1)) %>%
  group_by(sub_id, block_type) %>%
  summarize(prop_opt = mean(opt_choice, na.rm = T))

AI_choices <- full_join(AI_points, 
                             prop_opt_choices, 
                             by = c("block_type", "sub_id"))

#plot
LR_points_plot <- ggplot(AI_choices, aes(x = AI, y = prop_opt, color = block_type)) +
  geom_point() +
  facet_wrap(~block_type) +
  scale_color_manual(values = c(color1, color2)) +
  geom_smooth(method = "lm", color = "black", aes(fill = block_type)) +
  scale_fill_manual(values = c(color1, color2)) +
  ylab("Proportion of Optimal Choices") +
  xlab("Learning Rate Asymmetry") +
  casino.theme +
  theme(legend.position = "none")
LR_points_plot
```

### Model: AI vs. optimal choices
```{r AI and optimal choices earned model, include = F}
AI.choices.model <- mixed(prop_opt ~ age_scaled * block_type * AI_scaled + (1|sub_id), 
                  data = AI_choices,
                  method = "S",
                  expand_re = T)
```

```{r display AI choices model output}
nice(AI.choices.model)
```

## Asymmetry indices across blocks
### Model: Asymmetry index by block, block order, and age
```{r AI by block type block order and age model, include = F}
#process data
asymmetry_indices %<>%
  mutate(age_scaled = scale_this(age),
         block_order = factor(block_order),
         block_number = case_when(
           block_type == "Risk Bad" & block_order == "Risk Bad First" ~ 1,
           block_type == "Risk Bad" & block_order == "Risk Good First"  ~ 2,
           block_type == "Risk Good" & block_order == "Risk Bad First" ~ 2,
           block_type == "Risk Good" & block_order == "Risk Good First" ~ 1),
         block_number = factor(block_number))

AI.model <- mixed(AI ~ age_scaled * block_type * block_number + (1|sub_id), 
                  data = asymmetry_indices,
                  method = "S",
                  expand_re = T)

```

```{r display AI model output}
nice(AI.model)
```

### Model: Asymmetry index by block, block order, and age with gender
```{r AI by block type block order and age model with gender, include = F}
AI.model.gender <- mixed(AI ~ age_scaled * block_type * block_number * gender + (1|sub_id), 
                  data = asymmetry_indices,
                  method = "S",
                  expand_re = T)
```

```{r display AI model with gender output}
nice(AI.model.gender)
#just block type
# no effect of gender or interactions
```


### Model: Asymmetry index by block, block order, and age with motor perseveration scores
```{r AI model w/ motor persev, include = F}
persev_scores <- read_csv('data/other_data_files/persev_scores.csv')

AI_motor <- full_join(asymmetry_indices, persev_scores, by = c("sub_id", "age_group"))
AI_motor$persev_score_scaled <- scale_this(AI_motor$persev_score)

AI.model.motor_score <- mixed(AI ~ age_scaled * block_type * block_number * persev_score_scaled + (1|sub_id), 
                  data = AI_motor,
                  method = "S",
                  expand_re = T)
```

```{r display AI model with motor output}
nice(AI.model.motor_score)
# main effect of block type
# age x motor perseveration interaction effect
```

```{r motor perseveration age AI plot}
AI_motor$age_group <- factor(AI_motor$age_group, levels = c("Children", "Adolescents", "Adults"))

AI_motor_plot <- ggplot(AI_motor, aes(x = persev_score, y = AI, color = age_group, fill = age_group)) +
  geom_point() +
  geom_smooth(method = "lm") +
  scale_color_manual(values = c(color1, color2, color3), name = "Age Group") +
  scale_fill_manual(values = c(color1, color2, color3), name = "Age Group") +
  casino.theme +
  theme(legend.position = "none") +
  xlab("Perseveration Score") +
  ylab("Asymmetry Index")
AI_motor_plot
```

### Model: Asymmetry index by block, block order, and age with MaRs
```{r AI by block type block order and age model with mars, include = F}

#get mars data
mars_data <- read_csv("data/other_data_files/mars_accuracy.csv")

#combine with AI data
AI_mars <- inner_join(asymmetry_indices, mars_data, by = c("sub_id"))

#scale variables
AI_mars$age_scaled <- scale_this(AI_mars$age)
AI_mars$mars_scaled <- scale_this(AI_mars$mars_acc)


AI.model.mars <- mixed(AI ~ age_scaled * block_type * block_number * mars_scaled + (1|sub_id), 
                  data = AI_mars,
                  method = "S",
                  expand_re = T)
```

```{r display AI model with mars output}
nice(AI.model.mars)
# just block type
# no effect of mars or interactions
```


### Model: Asymmetry index by block, block order, and age excluding subs with many repeated choices
```{r AI model with sub exclusions, include = F}
same_choice_exclusions <- read_csv('data/other_data_files/sub_same_choice_exclusions.csv') %>%
  select(sub_id) %>%
  mutate(exclude = 1,
         sub_id = as.character(sub_id))

AI_exc <- full_join(asymmetry_indices, same_choice_exclusions, by = c("sub_id")) %>%
  replace_na(list(exclude=0)) %>%
  filter(exclude == 0)

#rescale age
AI_exc$age_scaled <- scale_this(AI_exc$age)

AI.model.exc <- mixed(AI ~ age_scaled * block_type * block_number  + (1|sub_id), 
                  data = AI_exc,
                  method = "S",
                  expand_re = T)
```

```{r display AI model with exclusions output}
nice(AI.model.exc)
# main effect of block type
# main effect of block number
```

### Models: AI by block and block order within age groups
#### Adults
```{r AI adult model}
#adults
adult_AI <- asymmetry_indices %>%
  filter(age_group == "Adults") 

adult_model <- mixed(AI ~ block_type * block_number + (1|sub_id),
                     data = adult_AI,
                     method = "S")
nice(adult_model)
```

#### Adolescents
```{r AI adolescent model}
#adolescents
adolescent_AI <- asymmetry_indices %>%
  filter(age_group == "Adolescents") 

adolescent_model <- mixed(AI ~ block_type * block_number + (1|sub_id),
                     data = adolescent_AI,
                     method = "S")
nice(adolescent_model)
```

#### Children
```{r AI child model}
#children
child_AI <- asymmetry_indices %>%
  filter(age_group == "Children") 

child_model <- mixed(AI ~ block_type * block_number + (1|sub_id),
                     data = child_AI,
                     method = "S")
nice(child_model) 
```

### Asymmetry indices by block type and age group 
```{r plot asymmetry indices by age group barplot}
AI_means <- asymmetry_indices %>%
  group_by(block_type, age_group) %>%
  summarize(mean_AI = mean(AI),
            N = n(), 
            stAI = sd(AI),
            seAI = stAI/sqrt(N)) %>%
  drop_na() 

AI_plot <- ggplot(AI_means, aes(x = block_type, y = mean_AI, fill = block_type)) +
  facet_wrap(~age_group) +
  geom_bar(stat = "identity", position = "dodge", color = "black") +
  geom_errorbar(aes(ymin = mean_AI - seAI, ymax = mean_AI + seAI), width = .1, position = position_dodge(width = .9)) +
  scale_fill_manual(values = c(color1, color2), name = "Block Type") +
  scale_x_discrete(labels = c("Risk Bad", "Risk Good")) +
  xlab("Block Type") +
  ylab("Mean Asymmetry Index") +
  coord_cartesian(ylim = c(-.25, .75)) +
  casino.theme +
  theme(legend.position = "none")
AI_plot
```

### Asymmetry indices by block type, block number, and age group
```{r plot asymmetry indices by age group with block order}
AI_means <- asymmetry_indices %>%
  group_by(block_type, age_group, block_order) %>%
  summarize(mean_AI = mean(AI),
            N = n(), 
            stAI = sd(AI),
            seAI = stAI/sqrt(N)) %>%
  drop_na() 

AI_plot <- ggplot(AI_means, aes(x = block_type, y = mean_AI, fill = block_type)) +
  facet_grid(cols = vars(age_group), rows = vars(block_order)) +
  geom_bar(stat = "identity", position = "dodge", color = "black") +
  geom_errorbar(aes(ymin = mean_AI - seAI, ymax = mean_AI + seAI), width = .1, position = position_dodge(width = .9)) +
  scale_fill_manual(values = c(color1, color2), name = "Block Type") +
  scale_x_discrete(labels = c("Risk Bad", "Risk Good")) +
  xlab("Block Type") +
  ylab("Mean Asymmetry Index") +
  coord_cartesian(ylim = c(-.25, .75)) +
  casino.theme +
  theme(legend.position = "none",
        panel.border = element_rect(fill = NA, size = .5),
        panel.background = element_blank(),
        axis.line = element_blank()) 
AI_plot
```

### Asymmetry indices individual data points
```{r plot asymmetry indices individual points, fig.width = 6, fig.height = 5}
AI_means <- asymmetry_indices %>%
  group_by(block_type, age_group) %>%
  summarize(mean_AI = mean(AI),
            N = n(), 
            stAI = sd(AI),
            seAI = stAI/sqrt(N)) %>%
  drop_na() 

AI_indiv_plot <- ggplot(asymmetry_indices, aes(x = block_type, y = AI, fill = block_type, color = block_type)) +
  facet_wrap(~age_group) +
  geom_line(aes(group = sub_id), color = 'black', size = .1) +
    geom_point(alpha = .5) +
  geom_line(data = AI_means, aes(x = block_type, y = mean_AI, group = age_group), color = "black", size = 1) +
    geom_point(data = AI_means, aes(x = block_type, y = mean_AI), size = 3, alpha = 1) +
  scale_color_manual(values = c(color1, color2), name = "Block Type") +
  scale_x_discrete(labels = c("Risk Bad", "Risk Good")) +
  xlab("Block Type") +
  ylab("Learning Rate Asymmetry") +
  casino.theme +
  theme(legend.position = "none")
AI_indiv_plot
```


### Asymmetry indices by continous age
```{r plot asymmetry indices continuous age, fig.width=7, fig.height = 4.5}

AI_cont_age_plot <- ggplot(asymmetry_indices, aes(x = age, y = AI, fill = block_type, color = block_type)) +
  geom_point() +
  geom_smooth(method = "lm") +
  scale_color_manual(values = c(color1, color2), name = "Block Type") +
  scale_fill_manual(values = c(color1, color2), name = "Block Type") +
  xlab("Age (Years)") +
  ylab("Learning Rate Asymmetry") +
  casino.theme
AI_cont_age_plot
```


## Learning rates
### Model: Negative learning rates by block, block order, and age
```{r process learing rates data}
#add sub IDs to model params
model_params <- inner_join(model_params, matlab_ids, by = c("matlab_id"))

#pivot longer
learning_rates <- model_params %>%
  select(sub_id, age, age_group, c(alpha_pos1:alpha_neg2)) %>%
  pivot_longer(cols = c(alpha_pos1:alpha_neg2), 
               values_to = "estimate",
               names_to = "LR") %>%
  mutate(block_type = case_when(LR == "alpha_pos1" ~ "Risk Good",
                           LR == "alpha_neg1" ~ "Risk Good",
                           LR == "alpha_pos2" ~ "Risk Bad",
                           LR == "alpha_neg2" ~ "Risk Bad"),
         valence = case_when(LR == "alpha_pos1" ~ "pos",
                           LR == "alpha_neg1" ~ "neg",
                           LR == "alpha_pos2" ~ "pos",
                           LR == "alpha_neg2" ~ "neg"))

#add block order
learning_rates <- inner_join(block_order, 
                             learning_rates, 
                             by = c("sub_id")) 

#process data for modeling
learning_rates %<>%
  mutate(age_scaled = scale_this(age),
         block = factor(block_type),
         valence = factor(valence),
         block_order = factor(block_order),
         block_number = case_when(block_order == "Risk Good First" & block_type == "Risk Good" ~ 1,
                                  block_order == "Risk Good First" & block_type == "Risk Bad" ~ 2,
                                  block_order == "Risk Bad First" & block_type == "Risk Good" ~ 2,
                                  block_order == "Risk Bad First" & block_type == "Risk Bad" ~ 1),
         block_number = factor(block_number))
```

```{r negative LR model, include = F}
neg.LR.model <- mixed(estimate ~ age_scaled * block_type * block_number  + (1|sub_id), 
                  data = learning_rates %>% filter(valence == "neg"),
                  method = "S", 
                  expand_re = T)
```

```{r show results from negative LR model}
nice(neg.LR.model)
```

```{r positive learning rates model, include = F}
pos.LR.model <- mixed(estimate ~ age_scaled * block_type * block_number  + (1|sub_id), 
                  data = learning_rates %>% filter(valence == "pos"),
                  method = "S", 
                  expand_re = T)
```

```{r show results from pos LR model}
nice(pos.LR.model)
```


```{r plot learning rates, fig.width = 7, fig.height = 5}
learning_rate_means <- learning_rates %>%
  group_by(age_group, valence,  block_type, block_number) %>%
  summarize(mean_est = mean(estimate, na.rm = T),
            se_est = se(estimate))

learning_rate_means$valence <- factor(learning_rate_means$valence, 
                                           labels = c("Negative Learning Rates", 
                                                      "Positive Learning Rates"))

learning_rate_plot <- ggplot(learning_rate_means, aes(x = block_number, y = mean_est, fill = block_type)) +
  facet_grid(cols = vars(age_group), rows = vars(valence))  +
  geom_bar(stat = "identity", position = "dodge", color = 'black') +
  geom_errorbar(aes(ymin = mean_est - se_est, ymax = mean_est + se_est), position = position_dodge(width = .9), width = .1) +
  scale_fill_manual(values = c(color1, color2), name = "Block Type") +
  ylab("Mean Parameter Estimate") +
  xlab("Block Number") +
  casino.theme +
    theme(panel.border = element_rect(fill = NA, size = .5),
    panel.background = element_blank(),
    axis.line = element_blank()) 
learning_rate_plot
```


## Relations between AI and mean RTs during learning
```{r AI RT relation}
#read in RTs
sub_rts <- read_csv("data/other_data_files/rt_means.csv")

#join with asymmetry indices
AI_RT <- full_join(asymmetry_indices, sub_rts, by = c("sub_id", "block_type")) 

#scale variables
AI_RT$age_scaled <- scale_this(AI_RT$age)
AI_RT$rt_scaled <- scale_this(AI_RT$mean_rt)
AI_RT$AI_scaled <- scale_this(AI_RT$AI)

AI.RT.model <- mixed(rt_scaled ~ age_scaled * AI_scaled * block_type * block_number + (1|sub_id), 
                  data = AI_RT, 
                  method = "S", 
                  expand_re = T)
```

```{r show results from AI RT model}
nice(AI.RT.model)
```

```{r RT AI plot}

RT.AI.plot <- ggplot(AI_RT, aes(x = AI, y = mean_rt, color = age_group)) +
  geom_point() +
  geom_smooth(method = "lm", aes(fill = age_group)) +
  xlab("Mean Asymmetry Index") +
  ylab("Mean Response Time (ms)") +
  scale_color_manual(values = c(color1, color2, color3), name = "Age Group") +
  scale_fill_manual(values = c(color1, color2, color3), name = "Age Group") +
  casino.theme
RT.AI.plot
```


## Relations between AI and measures of 'real-world' behavior
```{r survey data processing}
kid_surveys <- read_csv("data/surveys/child_survey_data_sept.csv")
adolescent_surveys <- read_csv("data/surveys/adolescents_survey_data_sept.csv")
adult_surveys <- read_csv("data/surveys/adult_survey_data_sept.csv")

#exclude participants who did not respond correctly to attention checks
survey_data <- rbind(kid_surveys, adolescent_surveys, adult_surveys) %>%
  filter(sub_id %in% matlab_ids$sub_id) %>%
  filter(attention_prop == 1)

#compute mean AI for each subject
mean_AI <- asymmetry_indices %>%
  group_by(sub_id, age, age_group) %>%
  summarize(meanAI = mean(AI))

#join with AI data
AI_survey <- inner_join(mean_AI, survey_data, by = c("sub_id")) 

#count number of subjects
AI_survey_subs <- AI_survey %>% 
  select(sub_id, age_group) %>%
  unique() %>%
  group_by(age_group) %>%
  summarize(n = n())

#display
kable(AI_survey_subs, col.names = c("Age Group", "N")) %>%
  kable_classic(full_width = F, html_font = "Arial") %>%
  kable_styling("striped")

#process data for models
AI_survey_data <- AI_survey %>%
  select(sub_id, age, age_group, meanAI, CDI_prop, likelihood_prop, Financial_likelihood_prop)

AI_survey_data$age_scaled = scale_this(AI_survey_data$age)
AI_survey_data$AI_scaled = scale_this(AI_survey_data$meanAI)
AI_survey_data$CDI_scaled = scale_this(AI_survey_data$CDI_prop)
AI_survey_data$overall_lik_scaled = scale_this(AI_survey_data$likelihood_prop)
AI_survey_data$financial_lik_scaled = scale_this(AI_survey_data$Financial_likelihood_prop)
```

  
## Model: AI and depressive symptomatology
```{r AI CDI relation}
AI.CDI.model <- lm(CDI_scaled ~ age_scaled * AI_scaled,
                  data = AI_survey_data)

AI.CDI.model %>% 
  tidy() %>%
  kable()%>%
  kable_classic(full_width = F, html_font = "Arial") %>%
  kable_styling("striped")
```

## Model: AI and overall risk-taking
```{r AI risk-taking relation}
AI.risk.model <- lm(overall_lik_scaled ~ age_scaled * AI_scaled, 
                  data = AI_survey_data)

AI.risk.model %>%
  tidy() %>%
  kable()%>%
  kable_classic(full_width = F, html_font = "Arial") %>%
  kable_styling("striped")
```
  
## Model: AI and financial risk-taking
```{r AI financial risk-taking relation}
AI.f_risk.model <- lm(financial_lik_scaled ~ age_scaled * AI_scaled, 
                  data = AI_survey_data)

AI.f_risk.model %>%
  tidy() %>%
  kable()%>%
  kable_classic(full_width = F, html_font = "Arial") %>%
  kable_styling("striped")
```

  
## Other model parameters
### Beta across age
```{r other params and age plots, fig.height = 5, fig.width = 5}
#Plot other parameters vs. age
betas <- model_params %>%
  select(sub_id, age, age_group,  beta)

#beta vs. age
beta_plot <- ggplot(betas, aes(x = age, y = beta))  +
  geom_point(size = 1, color = color2) +
  geom_smooth(method = "lm", color = color1, fill = color1) +
  xlab("Age") +
  ylab("Beta") +
  casino.theme
beta_plot
```

### Model: Beta vs. age
```{r other params and age models}
betas %<>% mutate(
  age_scaled = scale_this(age),
  beta_scaled = scale_this(beta))

#Beta vs. age
beta.model <- lm(beta_scaled ~ age_scaled, data = betas)
  
beta.model %>%
  tidy() %>%
  kable()%>%
  kable_classic(full_width = F, html_font = "Arial") %>%
  kable_styling("striped")
```

### Stickiness across age
```{r stickiness and age plots, fig.height = 5, fig.width = 5}
#Plot other parameters vs. age
stickiness <- model_params %>%
  select(sub_id, age, age_group,  sticky)

#beta vs. age
sticky_plot <- ggplot(stickiness, aes(x = age, y = sticky))  +
  geom_point(size = 1, color = color2) +
  geom_smooth(method = "lm", color = color1, fill = color1) +
  xlab("Age") +
  ylab("Choice Stickiness") +
  casino.theme
sticky_plot
```

### Model: Stickiness vs. age
```{r stickiness and age model}
stickiness %<>% mutate(
  age_scaled = scale_this(age),
  sticky_scaled = scale_this(sticky))

#Stickiness vs. age
sticky.model <- lm(sticky_scaled ~ age_scaled, data = stickiness)
  
sticky.model %>%
  tidy() %>%
  kable()%>%
  kable_classic(full_width = F, html_font = "Arial") %>%
  kable_styling("striped")
```



# Parameter estimates from decay model (4 alpha, 2 eta)
```{r read in decay RL results}
#read in parameter estimates
decay_params_name <- "RL_modeling/output/model_fits_real_data/params/decay_four_alpha_two_eta.csv"
decay_params <- read_csv(decay_params_name, 
                       col_names = c("matlab_id",
                                     "nll",
                                     "logpost",
                                     "bic",
                                     "aic",
                                     "beta",
                                     "sticky",
                                     "alpha_init_pos_risk_good",
                                     "alpha_init_neg_risk_good",
                                     "alpha_init_pos_risk_bad",
                                     "alpha_init_neg_risk_bad",
                                     "eta_pos",
                                     "eta_neg"))

#join w/ matlab IDs
decay_params <- full_join(decay_params, matlab_ids, by = c('matlab_id'))
```

```{r decay parameter estimates plots}
decay_params_long <- decay_params %>% pivot_longer(alpha_init_pos_risk_good:eta_neg,
                                                  names_to = 'param',
                                                  values_to = 'estimate')

decay_params_long$param <- factor(decay_params_long$param, 
                                  levels = c("alpha_init_pos_risk_good",
                                             "alpha_init_neg_risk_good",
                                             "alpha_init_pos_risk_bad",
                                             "alpha_init_neg_risk_bad",
                                             "eta_pos",
                                             "eta_neg"))

decay_param_means <- decay_params_long %>%
  group_by(age_group, param) %>%
  summarize(mean_estimate = mean(estimate, na.rm = T))

decay_param_plot <- ggplot(decay_param_means, aes(x = age_group, y = mean_estimate, fill = param), color = 'black') +
  geom_bar(stat = "identity", position = "dodge", color = 'black') +
  scale_fill_manual(values = c("blue", "forestgreen", "lightblue", "lightgreen", "red", "pink")) +
  xlab("Age Group") +
  ylab("Mean Estimate") +
  casino.theme
decay_param_plot
```

## Mean learning rates across trials
```{r positive and negative learning rate across trials, fig.width = 8, fig.height = 6}

#make data frame with list of trials for each sub
trial_num <- rep(c(1:100),times=284)
subs <- unique(decay_params$sub_id)
sub_id <- rep(subs, each=200)
sub_trials <- data.frame(sub_id, trial_num)

#add to decay learning rates
decay_learning_rates <- decay_params %>%
  select(sub_id, age, age_group, risk_good_first, alpha_init_pos_risk_good:eta_neg) %>%
  full_join(sub_trials, by = c("sub_id")) %>%
  mutate(pos_learning_rate_risk_good = alpha_init_pos_risk_good / (1 + eta_pos*(trial_num-1)),
         neg_learning_rate_risk_good = alpha_init_neg_risk_good / (1 + eta_neg*(trial_num-1)),
         pos_learning_rate_risk_bad = alpha_init_pos_risk_bad / (1 + eta_pos*(trial_num-1)),
         neg_learning_rate_risk_bad = alpha_init_neg_risk_bad/ (1 + eta_neg*(trial_num-1))) %>%
  select(sub_id, trial_num, age, age_group, risk_good_first, pos_learning_rate_risk_good:neg_learning_rate_risk_bad) %>%
  pivot_longer(cols = c(pos_learning_rate_risk_good:neg_learning_rate_risk_bad),
               names_to = "learning_rate",
               values_to = "estimate") %>%
  mutate(block_type = case_when(endsWith(learning_rate, "good") ~ "Risk Good",
                                endsWith(learning_rate, "bad") ~ "Risk Bad"),
         valence = case_when(startsWith(learning_rate, "pos") ~ "Positive",
                                startsWith(learning_rate, "neg") ~ "Negative"))


#compute mean learning rate across trials
decay_learning_rate_means <- decay_learning_rates %>%
  group_by(age_group, trial_num, block_type, valence) %>%
  summarize(mean_learning_rate = mean(estimate, na.rm = T),
            se_learning_rate = se(estimate))

#plot
decay_learning_rate_plot <- ggplot(decay_learning_rate_means, aes(x = trial_num, y = mean_learning_rate, color = valence)) +
  facet_grid(cols = vars(age_group), rows = vars(block_type)) +
  geom_point() +
  geom_errorbar(aes(ymin = mean_learning_rate - se_learning_rate,
                    ymax = mean_learning_rate + se_learning_rate),
                width = .1,
                alpha = .3) +
  geom_line(aes(group = valence)) +
  scale_color_manual(values = c(color1, color2)) +
  xlab("Trial") +
  ylab("Mean Learning Rate") +
  casino.theme
decay_learning_rate_plot 
```

## Mean AI across blocks
```{r decay plot mean AI across trials, fig.width = 7, fig.height = 5}
decay_AI <- decay_params %>%
  select(sub_id, age, age_group, risk_good_first, alpha_init_pos_risk_good:eta_neg) %>%
  full_join(sub_trials, by = c("sub_id")) %>%
  mutate(pos_learning_rate_risk_good = alpha_init_pos_risk_good / (1 + eta_pos*(trial_num-1)),
         neg_learning_rate_risk_good = alpha_init_neg_risk_good / (1 + eta_neg*(trial_num-1)),
         pos_learning_rate_risk_bad = alpha_init_pos_risk_bad / (1 + eta_pos*(trial_num-1)),
         neg_learning_rate_risk_bad = alpha_init_neg_risk_bad/ (1 + eta_neg*(trial_num-1)),
         risk_good = (pos_learning_rate_risk_good - neg_learning_rate_risk_good) / (pos_learning_rate_risk_good + neg_learning_rate_risk_good),
        risk_bad = (pos_learning_rate_risk_bad - neg_learning_rate_risk_bad) / (pos_learning_rate_risk_bad + neg_learning_rate_risk_bad)) %>%
  select(sub_id, trial_num, age, age_group, risk_good_first, risk_good, risk_bad) %>%
  pivot_longer(risk_good:risk_bad,
               names_to = "block_type",
               values_to = "AI")

#determine block number
decay_AI <- decay_AI %>%
  mutate(block_number = case_when(block_type == "risk_good" & risk_good_first == TRUE ~ 1,
                                  block_type == "risk_good" & risk_good_first == FALSE ~ 2,
                                  block_type == "risk_bad" & risk_good_first == TRUE ~ 2,
                                  block_type == "risk_bad" & risk_good_first == FALSE ~ 1))

decay_AI$block_number <- factor(decay_AI$block_number)


#compute mean AI
decay_AI_means <- decay_AI %>%
  group_by(age_group, trial_num, block_type) %>%
  summarize(mean_AI = mean(AI, na.rm = T),
            se_AI = se(AI))

#plot
decay_AI_plot <- ggplot(decay_AI_means, aes(x = trial_num, y = mean_AI, color = block_type)) +
  facet_grid(cols = vars(age_group)) +
  geom_point() +
  geom_errorbar(aes(ymin = mean_AI - se_AI,
                    ymax = mean_AI + se_AI),
                width = .1,
                alpha = .3) +
  geom_line(aes(group = block_type)) +
  scale_color_manual(values = c(color1, color2),
                     name = "Block Type",
                     labels = c("Risk Bad", "Risk Good")) +
  xlab("Trial") +
  ylab("Mean AI") +
  casino.theme
decay_AI_plot 
```

## Mean AI across block number
```{r decay plot mean AI across trials with block number, fig.width = 7, fig.height = 5}

#compute mean AI
decay_AI_means <- decay_AI %>%
  group_by(age_group, trial_num, block_number) %>%
  summarize(mean_AI = mean(AI, na.rm = T),
            se_AI = se(AI))

#plot
decay_AI_plot <- ggplot(decay_AI_means, aes(x = trial_num, y = mean_AI, color = block_number)) +
  facet_grid(cols = vars(age_group)) +
  geom_point() +
  geom_errorbar(aes(ymin = mean_AI - se_AI,
                    ymax = mean_AI + se_AI),
                width = .1,
                alpha = .3) +
  geom_line(aes(group = block_number)) +
  scale_color_manual(values = c(color1, color2),
                     name = "Block Number",
                     labels = c("1st Block", "2nd Block")) +
  xlab("Trial") +
  ylab("Mean AI") +
  casino.theme
decay_AI_plot 
```



## Model: Asymmetry index by trial, block, block number, and age
```{r AI across blocks model w/ decay params}

#scale variables
decay_AI$age_scaled <- scale_this(decay_AI$age)
decay_AI$trial_scaled <- scale_this(decay_AI$trial_num)

#run model
decay.AI.model <- mixed(AI ~ age_scaled * trial_scaled * block_type * block_number +
                          (trial_scaled + block_type + block_number| sub_id),
                          data = decay_AI,
                          method = "S",
                          expand_re = T,
                          control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e6)))
#does not converge w/ interactions in RE
```

```{r display output from decay AI model}
nice(decay.AI.model)
# trial
# trial x age
# trial x block type
# trial x block number
# age x trial x block type
# age x trial x block number
```




# Parameter estimates from decay model (4 alpha, 4 eta)
```{r read in decay RL results 2}
#read in parameter estimates
decay_params_name <- "RL_modeling/output/model_fits_real_data/params/decay_four_alpha_four_eta.csv"
decay_params <- read_csv(decay_params_name, 
                       col_names = c("matlab_id",
                                     "nll",
                                     "logpost",
                                     "bic",
                                     "aic",
                                     "beta",
                                     "sticky",
                                     "alpha_init_pos_risk_good",
                                     "alpha_init_neg_risk_good",
                                     "alpha_init_pos_risk_bad",
                                     "alpha_init_neg_risk_bad",
                                     "eta_pos_risk_good",
                                     "eta_neg_risk_good",
                                     "eta_pos_risk_bad",
                                     "eta_neg_risk_bad"))

#join w/ matlab IDs
decay_params <- full_join(decay_params, matlab_ids, by = c('matlab_id'))
```

```{r decay parameter estimates plots 2}
decay_params_long <- decay_params %>% pivot_longer(alpha_init_pos_risk_good:eta_neg_risk_bad,
                                                  names_to = 'param',
                                                  values_to = 'estimate')

decay_params_long$param <- factor(decay_params_long$param, 
                                  levels = c("alpha_init_pos_risk_good",
                                             "alpha_init_neg_risk_good",
                                             "alpha_init_pos_risk_bad",
                                             "alpha_init_neg_risk_bad",
                                              "eta_pos_risk_good",
                                              "eta_neg_risk_good",
                                              "eta_pos_risk_bad",
                                              "eta_neg_risk_bad"))

decay_param_means <- decay_params_long %>%
  group_by(age_group, param) %>%
  summarize(mean_estimate = mean(estimate, na.rm = T))

decay_param_plot <- ggplot(decay_param_means, aes(x = age_group, y = mean_estimate, fill = param), color = 'black') +
  geom_bar(stat = "identity", position = "dodge", color = 'black') +
  scale_fill_manual(values = c("blue", "forestgreen", "lightblue", "lightgreen", "red", "pink", "darkorange", "yellow")) +
  xlab("Age Group") +
  ylab("Mean Estimate") +
  casino.theme
decay_param_plot
```

## Mean learning rates across trials
```{r positive and negative learning rate across trials 2}

#make data frame with list of trials for each sub
trial_num <- rep(c(1:100),times=284)
subs <- unique(decay_params$sub_id)
sub_id <- rep(subs, each=200)
sub_trials <- data.frame(sub_id, trial_num)

#add to decay learning rates
decay_learning_rates <- decay_params %>%
  select(sub_id, age, age_group, risk_good_first, alpha_init_pos_risk_good:eta_neg_risk_bad) %>%
  full_join(sub_trials, by = c("sub_id")) %>%
  mutate(pos_learning_rate_risk_good = alpha_init_pos_risk_good / (1 + eta_pos_risk_good*(trial_num-1)),
         neg_learning_rate_risk_good = alpha_init_neg_risk_good / (1 + eta_neg_risk_good*(trial_num-1)),
         pos_learning_rate_risk_bad = alpha_init_pos_risk_bad / (1 + eta_pos_risk_bad*(trial_num-1)),
         neg_learning_rate_risk_bad = alpha_init_neg_risk_bad/ (1 + eta_neg_risk_bad*(trial_num-1))) %>%
  select(sub_id, trial_num, age, age_group, risk_good_first, pos_learning_rate_risk_good:neg_learning_rate_risk_bad) %>%
  pivot_longer(cols = c(pos_learning_rate_risk_good:neg_learning_rate_risk_bad),
               names_to = "learning_rate",
               values_to = "estimate") %>%
  mutate(block_type = case_when(endsWith(learning_rate, "good") ~ "Risk Good",
                                endsWith(learning_rate, "bad") ~ "Risk Bad"),
         valence = case_when(startsWith(learning_rate, "pos") ~ "Positive",
                                startsWith(learning_rate, "neg") ~ "Negative"))


#compute mean learning rate across trials
decay_learning_rate_means <- decay_learning_rates %>%
  group_by(age_group, trial_num, block_type, valence) %>%
  summarize(mean_learning_rate = mean(estimate, na.rm = T),
            se_learning_rate = se(estimate))

#plot
decay_learning_rate_plot <- ggplot(decay_learning_rate_means, aes(x = trial_num, y = mean_learning_rate, color = valence)) +
  facet_grid(cols = vars(age_group), rows = vars(block_type)) +
  geom_point() +
  geom_errorbar(aes(ymin = mean_learning_rate - se_learning_rate,
                    ymax = mean_learning_rate + se_learning_rate),
                 width = .1,
                alpha = .3) +
  geom_line(aes(group = valence)) +
  scale_color_manual(values = c(color1, color2)) +
  xlab("Trial") +
  ylab("Mean Learning Rate") +
  casino.theme
decay_learning_rate_plot 
```

## Mean AI across blocks
```{r decay plot mean AI across trials 2, fig.width = 7, fig.height = 5}
decay_AI <- decay_params %>%
  select(sub_id, age, age_group, risk_good_first, alpha_init_pos_risk_good:eta_neg_risk_bad) %>%
  full_join(sub_trials, by = c("sub_id")) %>%
  mutate(pos_learning_rate_risk_good = alpha_init_pos_risk_good / (1 + eta_pos_risk_good*(trial_num-1)),
         neg_learning_rate_risk_good = alpha_init_neg_risk_good / (1 + eta_neg_risk_good*(trial_num-1)),
         pos_learning_rate_risk_bad = alpha_init_pos_risk_bad / (1 + eta_pos_risk_bad*(trial_num-1)),
         neg_learning_rate_risk_bad = alpha_init_neg_risk_bad/ (1 + eta_neg_risk_bad*(trial_num-1)),
         risk_good = (pos_learning_rate_risk_good - neg_learning_rate_risk_good) / (pos_learning_rate_risk_good + neg_learning_rate_risk_good),
        risk_bad = (pos_learning_rate_risk_bad - neg_learning_rate_risk_bad) / (pos_learning_rate_risk_bad + neg_learning_rate_risk_bad)) %>%
  select(sub_id, trial_num, age, age_group, risk_good_first, risk_good, risk_bad) %>%
  pivot_longer(risk_good:risk_bad,
               names_to = "block_type",
               values_to = "AI")

#determine block number
decay_AI <- decay_AI %>%
  mutate(block_number = case_when(block_type == "risk_good" & risk_good_first == TRUE ~ 1,
                                  block_type == "risk_good" & risk_good_first == FALSE ~ 2,
                                  block_type == "risk_bad" & risk_good_first == TRUE ~ 2,
                                  block_type == "risk_bad" & risk_good_first == FALSE ~ 1))

decay_AI$block_number <- factor(decay_AI$block_number)


#compute mean AI
decay_AI_means <- decay_AI %>%
  group_by(age_group, trial_num, block_type) %>%
  summarize(mean_AI = mean(AI, na.rm = T),
            se_AI = se(AI))

#plot
decay_AI_plot <- ggplot(decay_AI_means, aes(x = trial_num, y = mean_AI, color = block_type)) +
  facet_grid(cols = vars(age_group)) +
  geom_point() +
  geom_errorbar(aes(ymin = mean_AI - se_AI,
                    ymax = mean_AI + se_AI),
                                width = .1,
                alpha = .3) +
  geom_line(aes(group = block_type)) +
  scale_color_manual(values = c(color1, color2),
                     name = "Block Type",
                     labels = c("Risk Bad", "Risk Good")) +
  xlab("Trial") +
  ylab("Mean AI") +
  casino.theme
decay_AI_plot 
```


## Model: Asymmetry index by trial, block, block number, and age
```{r AI across blocks model w/ decay params 2}

#scale variables
decay_AI$age_scaled <- scale_this(decay_AI$age)
decay_AI$trial_scaled <- scale_this(decay_AI$trial_num)

#run model
decay.AI.model <- mixed(AI ~ age_scaled * trial_scaled * block_type * block_number +
                          (trial_scaled + block_type + block_number| sub_id),
                          data = decay_AI,
                          method = "S",
                          expand_re = T,
                          control = lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=1e6)))
#does not converge w/ interactions in RE
```

```{r display output from decay AI model 2}
nice(decay.AI.model)
# trial
# trial x age
# trial x block type
# trial x block number
# age x trial x block type
# age x trial x block number
```